
#+options: ':nil *:t -:t ::t <:t H:3 \n:nil ^:t arch:headline
#+options: author:t broken-links:nil c:nil creator:nil
#+options: d:(not "LOGBOOK") date:t e:t email:nil expand-links:t f:t
#+options: inline:t num:t p:nil pri:nil prop:nil stat:t tags:t
#+options: tasks:t tex:t timestamp:t title:t toc:t todo:t |:t
#+title: SA-Toolkit
#+date: <2025-12-16 Mon>
#+author: David A. Ventimiglia
#+email: david.ventimiglia@supabase.io
#+language: en
#+select_tags: export
#+exclude_tags: noexport
#+creator: Emacs 30.1 (Org mode 9.7.11)
#+cite_export:

#+STARTUP: indent

* Overview

This is a Solutions Architect Toolkit---a collection of tools, scripts, and utilities for PostgreSQL diagnostics, troubleshooting, and migration tasks. While designed primarily for Supabase environments, most tools work with standard PostgreSQL installations.

* Tools

** [[file:pg-telemetry/README.md][pg-telemetry]]

Server-side performance telemetry for PostgreSQL 15, 16, or 17. Continuously collects metrics (WAL, checkpoints, wait events, locks, replication lag) via ~pg_cron~ and provides analysis functions to diagnose any time window.

#+begin_src bash
psql -f pg-telemetry/sql/install.sql
#+end_src

** [[file:multi-region-ha/README.md][multi-region-ha]]

Reference architecture for single-writer, multi-region disaster recovery for Supabase. Includes documentation, runbooks, and scripts for PgBouncer on Fly.io with controlled failover. Prioritizes data consistency over automatic failover (no split-brain).

- RTO: 2-5 minutes (scripted) / 5-15 minutes (manual)
- RPO: Seconds to minutes (replication lag dependent)

** [[file:storage-to-s3/README.md][storage-to-s3]]

One-time migration tool to move objects from Supabase Storage to AWS S3. Uses Supabase CLI for downloads and AWS CLI for uploads. Supports dry-run mode and verification.

#+begin_src bash
./storage-to-s3/scripts/migrate.sh --dry-run
./storage-to-s3/scripts/migrate.sh
./storage-to-s3/scripts/verify.sh
#+end_src

** [[file:enable-rls-automatically/README.md][enable-rls-automatically]]

PostgreSQL event trigger that automatically enables Row Level Security (RLS) with FORCE option on all newly-created tables in the public schema. Includes pgTAP test suite.

#+begin_src bash
supabase db push  # Deploy to Supabase
# or
psql -f enable-rls-automatically/install.sql  # Standalone PostgreSQL
#+end_src

* Design Principles

- *Standard libpq authentication*: Use ~PGHOST~, ~PGPORT~, ~PGUSER~, ~PGDATABASE~, ~PGPASSWORD~ environment variables or ~.pgpass~
- *Auto-detection over manual config*: Prefer querying the database for configuration (e.g., PG version) rather than requiring user input
- *Supabase-first, PostgreSQL-compatible*: Optimized for Supabase but works with standard PostgreSQL where possible

* Requirements

Requirements vary by tool. See individual README files for specifics:

| Tool | PostgreSQL | Extensions | Other |
|------+------------+------------+-------|
| pg-telemetry | 15, 16, 17 | pg_cron 1.4.1+ | - |
| multi-region-ha | 15+ | - | Fly.io, two Supabase projects |
| storage-to-s3 | - | - | Supabase CLI, AWS CLI v2 |
| enable-rls-automatically | 9.3+ | - | Superuser privileges |

* License

MIT
